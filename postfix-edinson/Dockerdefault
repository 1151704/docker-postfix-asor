# Usa una imagen base de Ubuntu
FROM ubuntu:20.04

# Actualiza los repositorios e instala Postfix, Dovecot, Nginx y PHP
RUN apt-get update 
RUN { \
        echo postfix postfix/mailname string 'postfixasor.com'; \
        echo postfix postfix/main_mailer_type string 'Internet Site'; \
    } | debconf-set-selections
RUN apt-get install --assume-yes postfix
#RUN apt-get dovecot-core dovecot-imapd dovecot-pop3d nginx php-fpm php-common php-mbstring php-xmlrpc php-soap php-gd php-xml php-cli php-zip -y
RUN apt-get update \
    && DEBIAN_FRONTEND=noninteractive apt-get install -y \
        dovecot-core \
        dovecot-imapd \
        dovecot-pop3d \
        mysql-server \
        nginx \
        php-fpm \
        php-common \
        php-mbstring \
        php-xmlrpc \
        php-soap \
        php-gd \
        php-xml \
        php-cli \
        php-zip \
    && rm -rf /var/lib/apt/lists/*


# Configura Postfix y Dovecot
COPY postfix-main.cf /etc/postfix/main.cf



COPY dovecot.conf /etc/dovecot/dovecot.
RUN echo "disable_plaintext_auth = no" > /etc/dovecot/conf.d/10-auth.conf
# Reemplazar la línea específica si existe
RUN sed -i 's/^#disable_plaintext_auth = yes/disable_plaintext_auth = no/' /etc/dovecot/conf.d/10-auth.conf

RUN echo "mail_location = maildir:~/Maildir" > /etc/dovecot/conf.d/10-mail.conf
# Reemplazar la línea específica si existe
RUN sed -i 's/^# *mail_location = maildir:~\/Maildir/mail_location = maildir:~\/Maildir/' /etc/dovecot/conf.d/10-mail.conf


# Instala Roundcube
#RUN apt-get install -y wget unzip
RUN apt-get update && apt-get install -y wget unzip  
RUN wget -O /tmp/roundcube.tar.gz https://github.com/roundcube/roundcubemail/releases/download/1.5.2/roundcubemail-1.5.2-complete.tar.gz \
    && tar -C /var/www/ -xzvf /tmp/roundcube.tar.gz \
    && mv /var/www/roundcubemail-1.5.2 /var/www/roundcube \
    && rm /tmp/roundcube.tar.gz

# Configura Nginx para servir Roundcube
# COPY roundcube /var/www/roundcube
COPY roundcube.conf /etc/nginx/sites-available/roundcube.conf
RUN ln -s /etc/nginx/sites-available/roundcube.conf /etc/nginx/sites-enabled/roundcube.conf

# Abre los puertos necesarios para SMTP, IMAP, POP3 y HTTP
EXPOSE 25 143 110 80

# Inicia los servicios al ejecutar el contenedor
CMD service postfix start && service dovecot start && service nginx start && service php7.4-fpm start && bash
#ENTRYPOINT ["bash", "-c", "service postfix start && service dovecot start && service nginx start && service php7.4-fpm start && bash"]
